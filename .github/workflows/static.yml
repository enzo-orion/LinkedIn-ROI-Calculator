import React, { useState, useEffect } from 'react';
import { Calculator, DollarSign, Users, Clock, Briefcase, ChevronRight, AlertCircle, TrendingUp } from 'lucide-react';

const HROutsourcingROI = () => {
  // --- STATE: MARKETING & FUNNEL ---
  const [adSpend, setAdSpend] = useState(2500);
  const [agencyFee, setAgencyFee] = useState(1500);
  const [techStackCost, setTechStackCost] = useState(165);
  const [leadsGenerated, setLeadsGenerated] = useState(25);
  const [bookingRate, setBookingRate] = useState(50); // %
  const [showRate, setShowRate] = useState(50); // %
  const [closeRate, setCloseRate] = useState(30); // %

  // --- STATE: UNIT ECONOMICS ---
  const [monthlyRetainer, setMonthlyRetainer] = useState(2000);
  const [avgRetentionMonths, setAvgRetentionMonths] = useState(12);
  const [grossMargin, setGrossMargin] = useState(40); // %
  const [onboardingCost, setOnboardingCost] = useState(900);

  // --- STATE: LABOR & COMMISSIONS ---
  // Sales Rep
  const [salesBaseSalary, setSalesBaseSalary] = useState(3500);
  const [salesCommPct, setSalesCommPct] = useState(2); // % of MRR
  const [salesCommDuration, setSalesCommDuration] = useState(12); // Months
  const [salesHourlyRate, setSalesHourlyRate] = useState(45); // Implied fully loaded hourly
  const [hoursPerLead, setHoursPerLead] = useState(0.5); // Chasing/Qualifying
  const [hoursPerBooked, setHoursPerBooked] = useState(1.5); // Prep + Call

  // HR Manager
  const [hrBaseSalary, setHrBaseSalary] = useState(9583);
  const [hrOneTimeCommPct, setHrOneTimeCommPct] = useState(10); // % of 1st month
  const [hrOngoingCommPct, setHrOngoingCommPct] = useState(2); // % of MRR
  const [hrOngoingDuration, setHrOngoingDuration] = useState(36); // Months limit

  // --- CALCULATIONS ---

  // Funnel Counts
  const bookedCalls = leadsGenerated * (bookingRate / 100);
  const showedCalls = bookedCalls * (showRate / 100);
  const newClients = showedCalls * (closeRate / 100);

  // Revenue
  const totalLTVRevenuePerClient = monthlyRetainer * avgRetentionMonths;
  const totalCampaignRevenue = newClients * totalLTVRevenuePerClient;
  const grossProfitPerClient = totalLTVRevenuePerClient * (grossMargin / 100);
  
  // Commission Calculations (Per Client)
  // Sales Comm: 2% of MRR for 12 months (or retention if lower)
  const salesCommTotal = (monthlyRetainer * (salesCommPct / 100)) * Math.min(salesCommDuration, avgRetentionMonths);
  
  // HR Comm: 10% one-time + 2% ongoing (capped at 36 months or retention)
  const hrOneTime = monthlyRetainer * (hrOneTimeCommPct / 100);
  const hrOngoing = (monthlyRetainer * (hrOngoingCommPct / 100)) * Math.min(hrOngoingDuration, avgRetentionMonths);
  const hrCommTotal = hrOneTime + hrOngoing;

  const totalCommissionsPerClient = salesCommTotal + hrCommTotal;

  // Labor Costs (Variable Time Spent)
  // Time spent on LEADS (chasing) + Time spent on CALLS (selling)
  // Note: We allocate the cost of ALL leads/calls to the acquired clients to get true CAC
  const totalSalesHours = (leadsGenerated * hoursPerLead) + (bookedCalls * hoursPerBooked);
  const totalSalesLaborCost = totalSalesHours * salesHourlyRate;

  // Fully Loaded Acquisition Costs
  const totalMarketingSpend = adSpend + agencyFee + techStackCost;
  const totalAcquisitionCost = totalMarketingSpend + totalSalesLaborCost;
  
  // CAC (Cost to Acquire a Customer)
  // Formula: (Marketing + Labor) / New Clients
  const cac = newClients > 0 ? totalAcquisitionCost / newClients : 0;

  // Net Profit Calculation
  // Gross Profit - (Commissions + Onboarding + CAC allocation)
  // We remove CAC from the "First Year" view usually, but for LTV ROI we subtract total costs.
  const netLifetimeValuePerClient = grossProfitPerClient - totalCommissionsPerClient - onboardingCost;
  const totalCampaignNetProfit = (newClients * netLifetimeValuePerClient) - totalAcquisitionCost;

  // ROI
  const roiMultiplier = totalAcquisitionCost > 0 ? (totalCampaignNetProfit / totalAcquisitionCost) : 0;
  const roiPercent = roiMultiplier * 100;

  // Break Even Analysis (Fixed Costs)
  const totalMonthlyFixed = salesBaseSalary + hrBaseSalary;
  // How much "Net LTV" does one client contribute?
  // We use this to see how many clients cover the base salaries.
  // Note: Usually base salary is covered by MRR margin, not just "profit". 
  // Simplified: How many new clients do we need to cover one month of burn?
  // Contribution Margin = Retainer - (Commission + Service Cost estimates)
  // Let's use the Net Lifetime Value for a cleaner "Campaign" break even.
  const clientsNeededForFixed = netLifetimeValuePerClient > 0 ? totalMonthlyFixed / (monthlyRetainer * (grossMargin/100)) : 0;


  const formatCurrency = (val: number) => {
    return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(val);
  };

  return (
    <div className="bg-slate-50 min-h-screen p-4 md:p-8 font-sans text-slate-800">
      <div className="max-w-7xl mx-auto">
        
        {/* HEADER */}
        <div className="mb-8">
          <h1 className="text-3xl font-bold text-slate-900">Fully Loaded ROI Modeler</h1>
          <p className="text-slate-500 mt-2">HR Outsourcing Services â€¢ Commission & Labor Impact Analysis</p>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-12 gap-6">

          {/* LEFT COLUMN: INPUTS (4 Columns wide) */}
          <div className="lg:col-span-4 space-y-6">
            
            {/* 1. MARKETING INPUTS */}
            <div className="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
              <div className="flex items-center gap-2 mb-4 text-blue-600">
                <Calculator size={20} />
                <h2 className="font-semibold text-lg">Marketing Funnel</h2>
              </div>
              
              <div className="space-y-4">
                <div>
                  <label className="text-xs font-bold text-slate-500 uppercase">Monthly Ad Spend ($)</label>
                  <input type="number" value={adSpend} onChange={e => setAdSpend(Number(e.target.value))} className="w-full mt-1 p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none" />
                </div>
                <div className="grid grid-cols-2 gap-4">
                   <div>
                    <label className="text-xs font-bold text-slate-500 uppercase">Agency Fee ($)</label>
                    <input type="number" value={agencyFee} onChange={e => setAgencyFee(Number(e.target.value))} className="w-full mt-1 p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none" />
                  </div>
                   <div>
                    <label className="text-xs font-bold text-slate-500 uppercase">Tech Stack ($)</label>
                    <input type="number" value={techStackCost} onChange={e => setTechStackCost(Number(e.target.value))} className="w-full mt-1 p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none" />
                  </div>
                </div>

                <div className="pt-4 border-t border-slate-100">
                   <div className="flex justify-between items-center mb-2">
                      <label className="text-sm font-medium">Leads Generated</label>
                      <input type="number" value={leadsGenerated} onChange={e => setLeadsGenerated(Number(e.target.value))} className="w-20 text-right p-1 border rounded bg-slate-50" />
                   </div>
                   <div className="flex justify-between items-center mb-2">
                      <label className="text-sm text-slate-500">Booking Rate (%)</label>
                      <input type="number" value={bookingRate} onChange={e => setBookingRate(Number(e.target.value))} className="w-20 text-right p-1 border rounded" />
                   </div>
                   <div className="flex justify-between items-center mb-2">
                      <label className="text-sm text-slate-500">Show Rate (%)</label>
                      <input type="number" value={showRate} onChange={e => setShowRate(Number(e.target.value))} className="w-20 text-right p-1 border rounded" />
                   </div>
                   <div className="flex justify-between items-center mb-2">
                      <label className="text-sm text-slate-500">Close Rate (%)</label>
                      <input type="number" value={closeRate} onChange={e => setCloseRate(Number(e.target.value))} className="w-20 text-right p-1 border rounded" />
                   </div>
                   
                   <div className="mt-3 bg-blue-50 p-3 rounded text-center">
                     <span className="text-sm text-blue-800 font-medium">New Clients: {newClients.toFixed(1)}</span>
                   </div>
                </div>
              </div>
            </div>

            {/* 2. UNIT ECONOMICS */}
            <div className="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
              <div className="flex items-center gap-2 mb-4 text-green-600">
                <DollarSign size={20} />
                <h2 className="font-semibold text-lg">Unit Economics</h2>
              </div>
              <div className="space-y-4">
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="text-xs font-bold text-slate-500 uppercase">Monthly Retainer</label>
                    <input type="number" value={monthlyRetainer} onChange={e => setMonthlyRetainer(Number(e.target.value))} className="w-full mt-1 p-2 border rounded focus:ring-2 focus:ring-green-500 outline-none" />
                  </div>
                  <div>
                    <label className="text-xs font-bold text-slate-500 uppercase">Retention (Mos)</label>
                    <input type="number" value={avgRetentionMonths} onChange={e => setAvgRetentionMonths(Number(e.target.value))} className="w-full mt-1 p-2 border rounded focus:ring-2 focus:ring-green-500 outline-none" />
                  </div>
                </div>
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="text-xs font-bold text-slate-500 uppercase">Gross Margin %</label>
                    <input type="number" value={grossMargin} onChange={e => setGrossMargin(Number(e.target.value))} className="w-full mt-1 p-2 border rounded focus:ring-2 focus:ring-green-500 outline-none" />
                  </div>
                  <div>
                    <label className="text-xs font-bold text-slate-500 uppercase">Onboarding Cost</label>
                    <input type="number" value={onboardingCost} onChange={e => setOnboardingCost(Number(e.target.value))} className="w-full mt-1 p-2 border rounded focus:ring-2 focus:ring-green-500 outline-none" />
                  </div>
                </div>
              </div>
            </div>

            {/* 3. LABOR & COMMISSIONS */}
            <div className="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
              <div className="flex items-center gap-2 mb-4 text-purple-600">
                <Users size={20} />
                <h2 className="font-semibold text-lg">Staff & Commissions</h2>
              </div>
              
              <div className="space-y-6">
                {/* Sales Rep */}
                <div>
                    <h3 className="text-sm font-bold text-slate-700 mb-2 border-b pb-1">Sales Role</h3>
                    <div className="grid grid-cols-2 gap-3 mb-2">
                        <div>
                            <label className="text-[10px] text-slate-500 uppercase">Base Salary</label>
                            <input type="number" value={salesBaseSalary} onChange={e => setSalesBaseSalary(Number(e.target.value))} className="w-full p-1 border rounded text-sm" />
                        </div>
                        <div>
                            <label className="text-[10px] text-slate-500 uppercase">Comm % (MRR)</label>
                            <div className="flex items-center">
                                <input type="number" value={salesCommPct} onChange={e => setSalesCommPct(Number(e.target.value))} className="w-full p-1 border rounded text-sm" />
                                <span className="text-xs ml-1 text-slate-400">x12mo</span>
                            </div>
                        </div>
                    </div>
                    <div className="bg-slate-50 p-2 rounded text-xs space-y-2">
                        <div className="flex justify-between">
                            <span>Labor Rate (est):</span>
                            <input type="number" value={salesHourlyRate} onChange={e => setSalesHourlyRate(Number(e.target.value))} className="w-16 text-right border rounded bg-white" />
                            <span className="text-slate-400">$/hr</span>
                        </div>
                         <div className="flex justify-between">
                            <span>Hours/Lead:</span>
                            <input type="number" value={hoursPerLead} onChange={e => setHoursPerLead(Number(e.target.value))} className="w-16 text-right border rounded bg-white" />
                        </div>
                         <div className="flex justify-between">
                            <span>Hours/Booking:</span>
                            <input type="number" value={hoursPerBooked} onChange={e => setHoursPerBooked(Number(e.target.value))} className="w-16 text-right border rounded bg-white" />
                        </div>
                    </div>
                </div>

                {/* HR Manager */}
                <div>
                    <h3 className="text-sm font-bold text-slate-700 mb-2 border-b pb-1">HR Manager</h3>
                    <div className="grid grid-cols-2 gap-3 mb-2">
                        <div>
                            <label className="text-[10px] text-slate-500 uppercase">Base Salary</label>
                            <input type="number" value={hrBaseSalary} onChange={e => setHrBaseSalary(Number(e.target.value))} className="w-full p-1 border rounded text-sm" />
                        </div>
                        <div>
                            <label className="text-[10px] text-slate-500 uppercase">One-Time Comm %</label>
                            <input type="number" value={hrOneTimeCommPct} onChange={e => setHrOneTimeCommPct(Number(e.target.value))} className="w-full p-1 border rounded text-sm" />
                        </div>
                    </div>
                     <div className="grid grid-cols-2 gap-3">
                        <div>
                            <label className="text-[10px] text-slate-500 uppercase">Ongoing %</label>
                            <div className="flex items-center">
                                <input type="number" value={hrOngoingCommPct} onChange={e => setHrOngoingCommPct(Number(e.target.value))} className="w-full p-1 border rounded text-sm" />
                                <span className="text-xs ml-1 text-slate-400">x36mo</span>
                            </div>
                        </div>
                    </div>
                </div>
              </div>
            </div>

          </div>


          {/* RIGHT COLUMN: DASHBOARD & RESULTS (8 Columns wide) */}
          <div className="lg:col-span-8 space-y-6">

            {/* TOP CARDS: KEY METRICS */}
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
              
              {/* CAC CARD */}
              <div className="bg-white p-6 rounded-xl shadow-sm border border-l-4 border-l-red-500">
                <div className="flex justify-between items-start">
                    <div>
                        <p className="text-sm font-medium text-slate-500">Fully Loaded CAC</p>
                        <h3 className="text-3xl font-bold text-slate-800 mt-1">{formatCurrency(cac)}</h3>
                    </div>
                    <div className="bg-red-50 p-2 rounded-full text-red-600">
                        <Users size={20} />
                    </div>
                </div>
                <div className="mt-4 text-xs text-slate-400">
                    Includes Ads, Agency, Tools & Sales Labor
                </div>
              </div>

               {/* LTV CARD */}
              <div className="bg-white p-6 rounded-xl shadow-sm border border-l-4 border-l-blue-500">
                <div className="flex justify-between items-start">
                    <div>
                        <p className="text-sm font-medium text-slate-500">LTV Revenue</p>
                        <h3 className="text-3xl font-bold text-slate-800 mt-1">{formatCurrency(totalLTVRevenuePerClient)}</h3>
                    </div>
                    <div className="bg-blue-50 p-2 rounded-full text-blue-600">
                        <TrendingUp size={20} />
                    </div>
                </div>
                <div className="mt-4 text-xs text-slate-400">
                    Based on {monthlyRetainer}/mo x {avgRetentionMonths} months
                </div>
              </div>

              {/* ROI CARD */}
               <div className={`bg-white p-6 rounded-xl shadow-sm border border-l-4 ${roiPercent > 0 ? 'border-l-green-500' : 'border-l-red-500'}`}>
                <div className="flex justify-between items-start">
                    <div>
                        <p className="text-sm font-medium text-slate-500">Campaign ROI</p>
                        <h3 className={`text-3xl font-bold mt-1 ${roiPercent > 0 ? 'text-green-600' : 'text-red-600'}`}>{roiPercent.toFixed(1)}%</h3>
                    </div>
                    <div className="bg-green-50 p-2 rounded-full text-green-600">
                        <DollarSign size={20} />
                    </div>
                </div>
                <div className="mt-4 text-xs text-slate-400">
                    Net Profit / Total Investment
                </div>
              </div>
            </div>

            {/* DETAILED WATERFALL BREAKDOWN */}
            <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                <div className="bg-slate-50 px-6 py-4 border-b border-slate-200">
                    <h3 className="font-bold text-lg text-slate-800">Financial Waterfall (Per Client)</h3>
                    <p className="text-sm text-slate-500">How your revenue gets eaten by costs</p>
                </div>
                
                <div className="p-6 space-y-4">
                    
                    {/* 1. GROSS REVENUE */}
                    <div className="flex justify-between items-center pb-2 border-b border-slate-100">
                        <span className="font-medium text-slate-700">Gross LTV Revenue</span>
                        <span className="font-bold text-slate-800">{formatCurrency(totalLTVRevenuePerClient)}</span>
                    </div>

                    {/* 2. GROSS PROFIT CALC */}
                    <div className="pl-4 space-y-2 text-sm text-slate-600 pb-2 border-b border-slate-100">
                        <div className="flex justify-between text-red-500">
                            <span>- Service Delivery Costs (60%)</span>
                            <span>{formatCurrency(totalLTVRevenuePerClient * (1 - (grossMargin/100)))}</span>
                        </div>
                        <div className="flex justify-between font-semibold text-slate-800 pt-1">
                            <span>= Gross Profit ({grossMargin}%)</span>
                            <span>{formatCurrency(grossProfitPerClient)}</span>
                        </div>
                    </div>

                    {/* 3. COMMISSIONS & ONBOARDING */}
                    <div className="pl-4 space-y-2 text-sm text-slate-600 pb-2 border-b border-slate-100">
                         <div className="flex justify-between text-red-500">
                            <div className="flex items-center gap-1">
                                <span>- Sales Commission</span>
                                <span className="text-[10px] bg-slate-100 px-1 rounded text-slate-400">2% for 12mo</span>
                            </div>
                            <span>{formatCurrency(salesCommTotal)}</span>
                        </div>
                         <div className="flex justify-between text-red-500">
                            <div className="flex items-center gap-1">
                                <span>- HR Mgr Commission</span>
                                <span className="text-[10px] bg-slate-100 px-1 rounded text-slate-400">10% + 2%</span>
                            </div>
                            <span>{formatCurrency(hrCommTotal)}</span>
                        </div>
                         <div className="flex justify-between text-red-500">
                            <span>- Onboarding/Setup Cost</span>
                            <span>{formatCurrency(onboardingCost)}</span>
                        </div>
                         <div className="flex justify-between font-semibold text-slate-800 pt-1 bg-slate-50 p-2 rounded">
                            <span>= Contribution Margin 2</span>
                            <span>{formatCurrency(grossProfitPerClient - totalCommissionsPerClient - onboardingCost)}</span>
                        </div>
                    </div>

                     {/* 4. ACQUISITION COSTS */}
                    <div className="pl-4 space-y-2 text-sm text-slate-600">
                        <div className="flex justify-between text-red-500">
                            <div className="flex items-center gap-1">
                                <span>- Marketing Allocation</span>
                                <span className="text-[10px] bg-slate-100 px-1 rounded text-slate-400">Ad Spend/Agency/Tech</span>
                            </div>
                            <span>{formatCurrency(totalMarketingSpend / newClients)}</span>
                        </div>
                        <div className="flex justify-between text-red-500">
                             <div className="flex items-center gap-1">
                                <span>- Sales Labor Allocation</span>
                                <span className="text-[10px] bg-slate-100 px-1 rounded text-slate-400">Prep/Call/Chase Time</span>
                            </div>
                            <span>{formatCurrency(totalSalesLaborCost / newClients)}</span>
                        </div>

                         <div className="flex justify-between items-center pt-3 mt-2 border-t border-slate-200">
                            <span className="font-bold text-lg text-blue-700">Net Profit Per Client</span>
                            <span className="font-bold text-xl text-blue-700">{formatCurrency(netLifetimeValuePerClient - (totalAcquisitionCost/newClients))}</span>
                        </div>
                    </div>

                </div>
            </div>

            {/* FIXED COSTS & REALITY CHECK */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                
                {/* SALARY BURNOUT */}
                <div className="bg-slate-800 text-white p-6 rounded-xl shadow-sm">
                    <div className="flex items-center gap-2 mb-4 text-yellow-400">
                        <AlertCircle size={20} />
                        <h3 className="font-semibold">The "Fixed Cost" Reality</h3>
                    </div>
                    <div className="space-y-4 text-sm">
                        <div className="flex justify-between border-b border-slate-700 pb-2">
                            <span>Monthly Base Salaries</span>
                            <span className="font-bold">{formatCurrency(totalMonthlyFixed)}</span>
                        </div>
                        <p className="text-slate-300 text-xs">
                            Your monthly fixed payroll is {formatCurrency(totalMonthlyFixed)}. 
                            Based on your Gross Margin of {grossMargin}%, you need:
                        </p>
                        <div className="flex justify-between items-center bg-slate-700 p-3 rounded">
                            <span className="text-yellow-400 font-bold text-xl">{clientsNeededForFixed.toFixed(1)} Active Clients</span>
                            <span className="text-xs text-slate-300">to break even on salary</span>
                        </div>
                        <p className="text-[10px] text-slate-400 italic">
                            (Assumes {formatCurrency(monthlyRetainer * (grossMargin/100))} gross profit contribution per active client/mo)
                        </p>
                    </div>
                </div>

                {/* CAMPAIGN SUMMARY */}
                <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                     <div className="flex items-center gap-2 mb-4 text-slate-600">
                        <Briefcase size={20} />
                        <h3 className="font-semibold">Campaign Total Outcomes</h3>
                    </div>
                    <div className="space-y-3 text-sm">
                        <div className="flex justify-between">
                            <span>Total Spend (Ads + Labor + Agency)</span>
                            <span className="font-medium text-red-600">{formatCurrency(totalAcquisitionCost)}</span>
                        </div>
                        <div className="flex justify-between">
                            <span>Total Net Profit Generated</span>
                            <span className="font-medium text-green-600">{formatCurrency(totalCampaignNetProfit)}</span>
                        </div>
                         <div className="flex justify-between">
                            <span>New Clients Acquired</span>
                            <span className="font-medium">{newClients.toFixed(1)}</span>
                        </div>
                    </div>
                </div>

            </div>

          </div>
        </div>
      </div>
    </div>
  );
};

export default HROutsourcingROI;
